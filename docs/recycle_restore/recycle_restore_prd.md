# 云盘系统-回收站还原功能 PRD

## 一、背景与目标

为提升用户体验，防止误删文件造成数据丢失，云盘系统需支持回收站功能。用户删除文件/文件夹后，文件将进入回收站。用户可在回收站中还原文件。若原路径已不存在（如父目录也被删除），系统需提示用户选择新的还原路径，确保文件安全还原。

---

## 二、需求描述

### 1. 主要场景

- 用户在回收站中选择还原文件/文件夹。
- 系统检测原路径是否存在。
- 若原路径存在，直接还原。
- 若原路径不存在，提示用户选择新的还原路径。
- 用户选择新路径后，文件/文件夹被还原到新路径下。

### 2. 详细流程

#### 2.1 正常还原
1. 用户在回收站选择文件，点击"还原"。
2. 系统检测原路径存在，文件还原到原路径。
3. 文件从回收站移除，出现在主文件列表。

#### 2.2 原路径不存在
1. 用户在回收站选择文件，点击"还原"。
2. 系统检测原路径不存在（如父目录也被删除）。
3. 系统返回错误码及提示："原路径不存在，请选择新的还原路径。"
4. 前端弹窗展示目录树，用户选择新的还原路径。
5. 用户确认后，前端携带新路径再次发起还原请求。
6. 系统将文件还原到新路径下，文件从回收站移除。

#### 2.3 还原失败
- 若新路径无权限、已存在同名文件、路径非法等，系统返回相应错误提示，用户可重新选择。

---

## 三、功能点

| 功能点         | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 回收站列表     | 展示所有被删除但未彻底删除的文件/文件夹                      |
| 还原操作       | 支持单个/批量还原                                            |
| 路径检测       | 后端检测原路径是否存在，若不存在需提示前端                   |
| 选择新路径     | 前端弹窗展示目录树，用户选择新路径                           |
| 还原到新路径   | 后端支持将文件/文件夹还原到用户指定的新路径                  |
| 错误处理       | 路径不存在、无权限、同名冲突等均需有明确错误提示              |

---

## 四、接口设计

### 1. 获取回收站文件列表

- **GET** `/api/recycle`
- **返回**：回收站文件/文件夹列表，含原路径、删除时间等信息

### 2. 还原文件/文件夹

- **POST** `/api/recycle/restore`
- **请求参数**：
  - `file_id`：要还原的文件/文件夹ID（支持批量）
  - `target_path`（可选）：新还原路径（为空则尝试原路径）

- **返回**：
  - 成功：`{"message": "还原成功"}`
  - 失败（原路径不存在）：`{"error": "原路径不存在，请选择新的还原路径"}`

### 3. 彻底删除

- **DELETE** `/api/recycle`
- **请求参数**：`file_id`（支持批量）

---

## 五、前端交互

- 用户点击"还原"按钮，若原路径不存在，弹窗提示"原路径不存在，请选择新的还原路径"，并展示目录树。
- 用户选择新路径后，点击"确定"提交。
- 还原成功后，文件从回收站消失，出现在新路径下。
- 还原失败时，弹窗展示具体错误信息。

---

## 六、数据结构建议

- 文件表增加字段：
  - `is_deleted`（bool/int）：是否被删除
  - `deleted_at`（datetime）：删除时间
  - `original_path`（string）：原始路径

---

## 七、权限与安全

- 仅文件所有者可还原文件。
- 还原到新路径时，需校验用户对目标路径有写入权限。
- 还原时如遇同名文件，需提示用户（可选择覆盖、重命名或取消）。

---

## 八、异常与边界场景

- 还原目标路径不存在/无权限/非法，需有明确提示。
- 支持批量还原，部分还原失败时需返回详细失败原因。
- 还原文件夹时需递归处理其下所有内容。

---

## 九、TDD测试建议

- 测试原路径存在时还原成功
- 测试原路径不存在时提示选择新路径
- 测试新路径还原成功
- 测试新路径无权限/非法/同名冲突等异常
- 测试批量还原部分失败

---

## 十、非功能需求

- 操作需有日志记录，便于审计和问题追踪
- 还原操作需保证原有文件属性（如创建时间、修改时间、权限等）不变 